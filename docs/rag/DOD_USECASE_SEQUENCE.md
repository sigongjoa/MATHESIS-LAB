# RAG 시스템 DoD, 유즈케이스 및 시퀀스 다이어그램

## 📋 목차
1. [Definition of Done (DoD)](#1-definition-of-done-dod)
2. [유즈케이스](#2-유즈케이스)
3. [시퀀스 다이어그램](#3-시퀀스-다이어그램)

---

## 1. Definition of Done (DoD)

### 1.1 기능 개발 DoD

각 기능이 "완료"로 간주되기 위한 체크리스트입니다.

#### ✅ 코드 품질
- [ ] 코드 리뷰 완료 (최소 1명 승인)
- [ ] 린트 에러 0개 (`pylint`, `eslint`)
- [ ] 타입 체크 통과 (`mypy`, `TypeScript`)
- [ ] 코드 커버리지 80% 이상
- [ ] 복잡도 기준 충족 (Cyclomatic Complexity < 10)

#### ✅ 테스트
- [ ] 단위 테스트 작성 및 통과
- [ ] 통합 테스트 작성 및 통과 (해당 시)
- [ ] E2E 테스트 작성 및 통과 (UI 변경 시)
- [ ] Golden Set 테스트 통과 (RAG 기능)
- [ ] 성능 테스트 통과 (응답 시간 < 3초)

#### ✅ 문서화
- [ ] API 문서 업데이트 (OpenAPI/Swagger)
- [ ] README 업데이트 (새 기능 설명)
- [ ] 인라인 주석 작성 (복잡한 로직)
- [ ] 변경 로그 작성 (CHANGELOG.md)

#### ✅ 배포 준비
- [ ] 마이그레이션 스크립트 작성 (DB 변경 시)
- [ ] 환경 변수 문서화 (.env.example)
- [ ] CI/CD 파이프라인 통과
- [ ] 스테이징 환경 배포 및 검증

#### ✅ 보안 및 성능
- [ ] 보안 취약점 스캔 통과
- [ ] 민감 정보 하드코딩 없음
- [ ] SQL Injection 방어 확인
- [ ] Rate Limiting 적용 확인

---

### 1.2 스프린트 DoD

스프린트가 완료되기 위한 조건입니다.

#### ✅ 스프린트 목표
- [ ] 모든 스프린트 목표 달성
- [ ] 계획된 스토리 포인트 80% 이상 완료
- [ ] 블로커 이슈 0개

#### ✅ 품질 보증
- [ ] 전체 테스트 스위트 통과
- [ ] 회귀 테스트 통과
- [ ] 성능 저하 없음 (기준선 대비)

#### ✅ 문서 및 커뮤니케이션
- [ ] 스프린트 리뷰 완료
- [ ] 회고 완료 및 액션 아이템 정의
- [ ] 다음 스프린트 백로그 준비

---

### 1.3 릴리스 DoD

프로덕션 배포를 위한 조건입니다.

#### ✅ 기능 완성도
- [ ] 모든 필수 기능 구현 완료
- [ ] UAT (User Acceptance Testing) 통과
- [ ] 알려진 크리티컬 버그 0개

#### ✅ 성능 및 안정성
- [ ] 부하 테스트 통과 (목표: 100 QPS)
- [ ] 장애 복구 테스트 통과
- [ ] 데이터 백업 및 복구 절차 검증

#### ✅ 문서 및 교육
- [ ] 사용자 매뉴얼 작성
- [ ] 운영 가이드 작성
- [ ] 팀 교육 완료

#### ✅ 배포 준비
- [ ] 롤백 계획 수립
- [ ] 모니터링 대시보드 설정
- [ ] 알림 규칙 설정
- [ ] 프로덕션 환경 검증

---

## 2. 유즈케이스

### 2.1 UC-001: 교사가 교육과정 질의

**액터**: 교사  
**목표**: 특정 학년의 성취기준에 대한 정보를 얻는다  
**전제조건**: 
- 교사가 로그인되어 있음
- 해당 교육과정 문서가 인덱싱되어 있음

**기본 플로우**:
1. 교사가 AI Assistant를 연다
2. 교사가 질문을 입력한다: "초등학교 5~6학년 수학에서 최대공약수는 소인수분해로 다루나요?"
3. 시스템이 질문을 분석하고 메타데이터를 추출한다
4. 시스템이 벡터 검색을 수행한다
5. 시스템이 LLM을 통해 답변을 생성한다
6. 시스템이 답변과 출처를 표시한다
7. 교사가 답변을 확인한다

**대체 플로우**:
- 3a. 질문이 모호한 경우
  - 시스템이 명확화 질문을 한다
  - 교사가 추가 정보를 제공한다
- 4a. 관련 문서를 찾지 못한 경우
  - 시스템이 "관련 정보를 찾을 수 없습니다"라고 응답한다
  - 교사가 필터를 조정하거나 질문을 다시 작성한다

**후행조건**:
- 질의 로그가 저장됨
- 교사가 피드백을 제공할 수 있음

---

### 2.2 UC-002: 관리자가 새 교육과정 문서 인덱싱

**액터**: 관리자  
**목표**: 새로 발표된 교육과정 문서를 시스템에 추가한다  
**전제조건**: 
- 관리자 권한이 있음
- 문서가 PDF 또는 HWP 형식임

**기본 플로우**:
1. 관리자가 RAG 관리 페이지에 접속한다
2. 관리자가 "문서 업로드" 버튼을 클릭한다
3. 관리자가 파일을 선택한다
4. 관리자가 메타데이터를 입력한다:
   - 문서 유형: 교육과정
   - 개정 연도: 2022개정
   - 범위: 국가
5. 관리자가 "업로드 시작" 버튼을 클릭한다
6. 시스템이 문서를 파싱한다
7. 시스템이 청크를 생성한다
8. 시스템이 임베딩을 생성한다
9. 시스템이 벡터 DB에 저장한다
10. 시스템이 완료 메시지를 표시한다

**대체 플로우**:
- 6a. 파싱 실패
  - 시스템이 에러 메시지를 표시한다
  - 관리자가 파일 형식을 확인하고 재시도한다
- 8a. API 할당량 초과
  - 시스템이 작업을 일시 중지한다
  - 시스템이 1시간 후 자동 재시도한다

**후행조건**:
- 문서가 인덱싱됨
- 사용자가 해당 문서에 대해 질의할 수 있음

---

### 2.3 UC-003: 교사가 학교 계획과 국가 지침 비교

**액터**: 교사  
**목표**: 학교의 평가 계획이 국가 교육과정 지침을 잘 반영하는지 확인한다  
**전제조건**: 
- 국가 교육과정 문서와 학교 계획 문서가 모두 인덱싱되어 있음

**기본 플로우**:
1. 교사가 AI Assistant를 연다
2. 교사가 질문을 입력한다: "우리 학교의 수학 평가 계획이 국가 교육과정의 평가 원칙을 잘 반영하고 있나요?"
3. 시스템이 두 소스(NATIONAL, SCHOOL)에서 검색한다
4. 시스템이 비교 분석을 수행한다
5. 시스템이 비교 결과를 표시한다:
   - 일치하는 부분
   - 차이점
   - 개선 제안
6. 교사가 결과를 검토한다

**후행조건**:
- 교사가 평가 계획 개선에 활용할 수 있음

---

### 2.4 UC-004: 사용자가 답변에 피드백 제공

**액터**: 교사  
**목표**: 답변의 정확성에 대한 피드백을 제공한다  
**전제조건**: 
- 질의 응답을 받은 상태

**기본 플로우**:
1. 교사가 답변을 검토한다
2. 교사가 "도움이 되었나요?" 섹션에서 평점을 선택한다 (1~5)
3. 교사가 피드백 유형을 선택한다: "정확함"
4. 교사가 선택적으로 코멘트를 작성한다
5. 교사가 "제출" 버튼을 클릭한다
6. 시스템이 피드백을 저장한다
7. 시스템이 감사 메시지를 표시한다

**후행조건**:
- 피드백이 품질 개선에 활용됨

---

## 3. 시퀀스 다이어그램

### 3.1 RAG 질의 응답 플로우

```
사용자    프론트엔드    API Gateway    RAG Service    Vector Store    LLM    PostgreSQL
  │           │              │              │               │          │         │
  │  질문 입력 │              │              │               │          │         │
  ├──────────>│              │              │               │          │         │
  │           │ POST /rag/query             │               │          │         │
  │           ├─────────────>│              │               │          │         │
  │           │              │ 인증 확인     │               │          │         │
  │           │              ├─────────────>│               │          │         │
  │           │              │              │ 1. 질의 임베딩 │          │         │
  │           │              │              ├──────────────────────────>│         │
  │           │              │              │<──────────────────────────┤         │
  │           │              │              │ embedding                 │         │
  │           │              │              │               │          │         │
  │           │              │              │ 2. 벡터 검색   │          │         │
  │           │              │              ├──────────────>│          │         │
  │           │              │              │<──────────────┤          │         │
  │           │              │              │ search results│          │         │
  │           │              │              │               │          │         │
  │           │              │              │ 3. 프롬프트 구성│          │         │
  │           │              │              │               │          │         │
  │           │              │              │ 4. LLM 호출    │          │         │
  │           │              │              ├─────────────────────────>│         │
  │           │              │              │<─────────────────────────┤         │
  │           │              │              │ answer                   │         │
  │           │              │              │               │          │         │
  │           │              │              │ 5. 로그 저장   │          │         │
  │           │              │              ├────────────────────────────────────>│
  │           │              │              │               │          │         │
  │           │              │<─────────────┤               │          │         │
  │           │<─────────────┤ response     │               │          │         │
  │<──────────┤              │              │               │          │         │
  │  답변 표시 │              │              │               │          │         │
```

### 3.2 문서 인덱싱 플로우

```
관리자    프론트엔드    API Gateway    Parser Service    Embedding Service    Vector Store    PostgreSQL
  │           │              │              │                    │                  │              │
  │ 파일 업로드│              │              │                    │                  │              │
  ├──────────>│              │              │                    │                  │              │
  │           │ POST /rag/index (multipart) │                    │                  │              │
  │           ├─────────────>│              │                    │                  │              │
  │           │              │ 1. 파일 저장  │                    │                  │              │
  │           │              ├─────────────>│                    │                  │              │
  │           │              │              │ 2. 문서 파싱        │                  │              │
  │           │              │              ├───────────────────>│                  │              │
  │           │              │              │<───────────────────┤                  │              │
  │           │              │              │ chunks             │                  │              │
  │           │              │              │                    │                  │              │
  │           │              │              │ 3. 임베딩 생성 (배치)│                  │              │
  │           │              │              ├───────────────────>│                  │              │
  │           │              │              │<───────────────────┤                  │              │
  │           │              │              │ embeddings         │                  │              │
  │           │              │              │                    │                  │              │
  │           │              │              │ 4. 벡터 저장        │                  │              │
  │           │              │              ├────────────────────────────────────>│              │
  │           │              │              │                    │                  │              │
  │           │              │              │ 5. 메타데이터 저장  │                  │              │
  │           │              │              ├──────────────────────────────────────────────────>│
  │           │              │<─────────────┤                    │                  │              │
  │           │<─────────────┤ job_id       │                    │                  │              │
  │<──────────┤              │              │                    │                  │              │
  │ 작업 ID    │              │              │                    │                  │              │
  │           │              │              │                    │                  │              │
  │ 상태 폴링  │              │              │                    │                  │              │
  ├──────────>│              │              │                    │                  │              │
  │           │ GET /rag/status/{job_id}    │                    │                  │              │
  │           ├─────────────>│              │                    │                  │              │
  │           │              ├──────────────────────────────────────────────────────────────────>│
  │           │              │<────────────────────────────────────────────────────────────────────┤
  │           │<─────────────┤ status: processing, progress: 65%│                  │              │
  │<──────────┤              │              │                    │                  │              │
```

### 3.3 피드백 제공 플로우

```
사용자    프론트엔드    API Gateway    RAG Service    PostgreSQL
  │           │              │              │              │
  │ 피드백 제공│              │              │              │
  ├──────────>│              │              │              │
  │           │ POST /rag/feedback          │              │
  │           ├─────────────>│              │              │
  │           │              │ 검증          │              │
  │           │              ├─────────────>│              │
  │           │              │              │ 피드백 저장   │
  │           │              │              ├─────────────>│
  │           │              │              │<─────────────┤
  │           │              │<─────────────┤              │
  │           │<─────────────┤ feedback_id  │              │
  │<──────────┤              │              │              │
  │ 감사 메시지│              │              │              │
```

### 3.4 에러 처리 플로우

```
사용자    프론트엔드    API Gateway    RAG Service    Vector Store    LLM
  │           │              │              │               │          │
  │  질문 입력 │              │              │               │          │
  ├──────────>│              │              │               │          │
  │           │ POST /rag/query             │               │          │
  │           ├─────────────>│              │               │          │
  │           │              ├─────────────>│               │          │
  │           │              │              │ 벡터 검색      │          │
  │           │              │              ├──────────────>│          │
  │           │              │              │   TIMEOUT     │          │
  │           │              │              │<──────────────┤          │
  │           │              │              │               │          │
  │           │              │              │ 재시도 (1/3)   │          │
  │           │              │              ├──────────────>│          │
  │           │              │              │   TIMEOUT     │          │
  │           │              │              │<──────────────┤          │
  │           │              │              │               │          │
  │           │              │              │ 재시도 (2/3)   │          │
  │           │              │              ├──────────────>│          │
  │           │              │              │   SUCCESS     │          │
  │           │              │              │<──────────────┤          │
  │           │              │              │               │          │
  │           │              │              │ LLM 호출       │          │
  │           │              │              ├─────────────────────────>│
  │           │              │              │   QUOTA_EXCEEDED         │
  │           │              │              │<─────────────────────────┤
  │           │              │              │               │          │
  │           │              │              │ 에러 로그 저장 │          │
  │           │              │<─────────────┤               │          │
  │           │<─────────────┤ 429 Too Many Requests        │          │
  │<──────────┤              │              │               │          │
  │ 에러 메시지│              │              │               │          │
  │ "잠시 후   │              │              │               │          │
  │ 다시 시도" │              │              │               │          │
```

---

## 4. 상태 다이어그램

### 4.1 문서 인덱싱 상태

```
     ┌─────────┐
     │ PENDING │
     └────┬────┘
          │ start indexing
          ▼
    ┌────────────┐
    │ PROCESSING │◄────┐
    └─────┬──────┘     │
          │            │ retry
          ├────────────┘
          │
          ├─── parsing ───>┐
          ├─── embedding ──>│
          └─── indexing ───>│
                            │
          ┌─────────────────┘
          │
          ▼
    ┌───────────┐
    │ COMPLETED │
    └───────────┘
          │
          │ error
          ▼
    ┌─────────┐
    │ FAILED  │
    └─────────┘
```

### 4.2 질의 처리 상태

```
    ┌─────────┐
    │ CREATED │
    └────┬────┘
         │
         ▼
   ┌──────────┐
   │ EMBEDDING│
   └────┬─────┘
        │
        ▼
   ┌──────────┐
   │ SEARCHING│
   └────┬─────┘
        │
        ▼
   ┌──────────┐
   │GENERATING│
   └────┬─────┘
        │
        ▼
   ┌──────────┐
   │COMPLETED │
   └──────────┘
```

---

**문서 버전**: 1.0  
**작성일**: 2025-11-20  
**작성자**: MATHESIS LAB 개발팀
