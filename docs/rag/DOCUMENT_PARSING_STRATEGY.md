# 문서 파싱 및 처리 전략 가이드

이 문서는 `[별책8]+수학과+교육과정.pdf` 및 `2025학년도 2학기 3학년 교과별 교수학습 및 평가 운영 계획(수정).hwp`와 같은 교육 과정 및 운영 계획 문서들을 RAG 시스템에서 효과적으로 처리하기 위한 파싱 전략을 기술합니다.

## 1. 개요

RAG 시스템의 성능은 원본 문서에서 얼마나 정확하고 의미 있는 데이터를 추출하느냐에 달려 있습니다. 특히 교육 관련 문서는 **표(Table)**, **계층적 구조(Hierarchy)**, **메타데이터(Metadata)**가 중요하므로 단순 텍스트 추출 이상의 전략이 필요합니다.

## 2. 대상 문서 유형 및 특성

| 문서 유형 | 예시 파일 | 주요 특징 | 파싱 난이도 |
| :--- | :--- | :--- | :--- |
| **PDF (구조화)** | `[별책8]+수학과+교육과정.pdf` | 성취기준 코드(`[2수01-01]`), 표 중심 레이아웃, 명확한 계층 구조 | 중~상 |
| **HWP (한글)** | `...교수학습 및 평가 운영 계획.hwp` | 표 안에 텍스트가 많음, HWP 바이너리 포맷, 비정형 레이아웃 | 상 |

---

## 3. PDF 파싱 전략 (`[별책8]+수학과+교육과정.pdf`)

이 문서는 국가 교육과정 표준으로, 매우 정형화된 구조를 가지고 있습니다.

### 3.1. 도구 (Tools)
- **PyMuPDF (fitz)**: 속도가 빠르고 텍스트 레이아웃 보존이 우수하여 기본 파서로 사용합니다.
- **pdfplumber**: 표(Table) 추출에 특화되어 있어, 복잡한 성취기준 표를 구조화된 데이터로 변환할 때 사용합니다.

### 3.2. 처리 프로세스
1.  **구조 인식**:
    *   문서의 목차(TOC)나 헤더 폰트 크기를 분석하여 `학교급 > 학년군 > 영역 > 성취기준`의 계층 구조를 파악합니다.
2.  **성취기준 추출 (핵심)**:
    *   정규식 패턴 `\[\d+[가-힣]+\d+-\d+\]` (예: `[2수01-01]`)을 사용하여 성취기준 코드를 식별합니다.
    *   해당 코드가 포함된 행(Row)이나 단락을 하나의 **의미 단위(Semantic Chunk)**로 캡처합니다.
3.  **표 데이터 변환**:
    *   표 내부의 텍스트는 단순 나열이 아니라 `Key: Value` 형태(예: `평가 방법: 지필평가`)로 변환하여 LLM이 문맥을 이해하기 쉽게 만듭니다.

### 3.3. 청킹 (Chunking) 전략
*   **Semantic Chunking**: 페이지 단위가 아닌 **성취기준 단위**로 자릅니다.
*   **Context Injection**: 각 청크에 상위 계층 정보(예: "초등학교 1~2학년 > 수와 연산")를 메타데이터로 함께 주입하여 검색 정확도를 높입니다.

---

## 4. HWP 파싱 전략 (`...교수학습 및 평가 운영 계획(수정).hwp`)

학교 현장에서 생성되는 운영 계획서는 HWP 포맷이 압도적으로 많으며, 대부분 **표(Table)**를 레이아웃 도구로 사용합니다.

### 4.1. 도구 (Tools)
- **pyhwp (hwp5txt)**: HWP 5.0 포맷을 텍스트나 HTML로 변환하는 Python 라이브러리입니다.
- **HwpConverter (Custom)**: `pyhwp`로 처리가 어려운 경우, HWP를 PDF로 변환 후 PDF 파서를 사용하는 우회 전략을 사용합니다. (서버 환경에 따라 선택)

### 4.2. 처리 프로세스
1.  **포맷 변환 (HWP -> Text/HTML)**:
    *   HWP 파일은 바이너리 구조이므로 직접 파싱보다는 `hwp5txt`를 통해 텍스트나 XHTML로 변환하는 것이 안정적입니다.
    *   **XHTML 변환 권장**: 표 구조(`<table>`)가 태그로 보존되므로, 단순 텍스트 변환보다 구조 파악이 유리합니다.
2.  **메타데이터 추출 (파일명 및 헤더)**:
    *   파일명에서 핵심 정보를 추출합니다.
        *   `2025학년도` -> **Year**: 2025
        *   `2학기` -> **Semester**: 2
        *   `3학년` -> **Grade**: 3
        *   `교과별` -> **Type**: Department/Subject Plan
3.  **섹션 분리**:
    *   "1. 교과 목표", "2. 평가 방침", "3. 평가 계획"과 같은 번호 매기기 패턴을 식별하여 문서를 섹션별로 분할합니다.

### 4.3. 청킹 (Chunking) 전략
*   **Section-based Chunking**: 문서의 대단원(1., 2., 3. ...) 단위로 1차 분할합니다.
*   **Table-row Chunking**: "평가 계획"과 같은 거대한 표는 행(Row) 단위(예: 단원별 평가 계획)로 쪼개어 저장합니다.

---

## 5. 유사 문서 처리를 위한 통합 파이프라인 (Unified Pipeline)

향후 추가될 유사 문서들을 일관성 있게 처리하기 위한 파이프라인입니다.

### 5.1. Ingestion Layer
*   **File Router**: 파일 확장자(.pdf, .hwp)를 감지하여 적절한 파서(Parser)로 라우팅합니다.
*   **Metadata Extractor**: 파일명, 경로, 파일 속성에서 공통 메타데이터(작성년도, 학년, 과목 등)를 우선 추출합니다.

### 5.2. Parsing Layer
*   **PDF Parser**: `PyMuPDF` 기반. 구조화된 텍스트 추출.
*   **HWP Parser**: `pyhwp` 기반. XHTML 변환 후 `BeautifulSoup` 등으로 태그 및 텍스트 추출.

### 5.3. Normalization Layer (정규화)
모든 파싱 결과는 아래와 같은 공통 포맷(Markdown)으로 변환됩니다.

```markdown
# 메타데이터
- Year: 2025
- Grade: 3
- Subject: 수학

# 본문
## [성취기준 코드] 성취기준 내용
- 관련 단원: ...
- 평가 방법: ...
```

### 5.4. Indexing Layer
*   정규화된 Markdown 텍스트를 기반으로 임베딩을 생성하고 Vector DB에 저장합니다.

## 6. 결론 및 제언

1.  **HWP 처리의 복잡성**: HWP는 완벽한 파싱이 어렵습니다. 1차적으로 `pyhwp`를 시도하되, 실패 시 PDF로 변환하여 처리하는 **Fallback 메커니즘**을 구현해야 합니다.
2.  **메타데이터의 중요성**: 파일 내용만큼이나 파일명에 포함된 정보(학년, 학기)가 중요하므로, 이를 놓치지 않고 DB 필드로 저장해야 합니다.
3.  **검증**: 파싱 후 무작위 샘플링을 통해 표의 내용이 깨지지 않고 올바르게 연결되었는지 육안 검증이 필요합니다.
